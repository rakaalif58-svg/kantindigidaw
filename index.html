<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kantin Siswa Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f0fdf4; /* green-50, for a natural base */
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-primary {
            /* Changed to a green, nature-themed gradient */
            background-image: linear-gradient(to right, #10b981, #059669); /* emerald-500 to green-600 */
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(5, 150, 105, 0.3); /* green-600 shadow */
        }
        .btn-primary:hover {
            box-shadow: 0 6px 20px 0 rgba(5, 150, 105, 0.4); /* green-600 shadow hover */
            transform: translateY(-2px);
        }
        .card {
            background-color: white;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.05), 0 4px 6px -4px rgb(0 0 0 / 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.07), 0 8px 10px -6px rgb(0 0 0 / 0.07);
        }
    </style>
</head>
<body class="bg-slate-50">

    <div id="app"></div>

    <script>
        // --- DATA SIMULASI (Pengganti Database) ---
        // Dalam aplikasi nyata, data ini akan diambil dari server.
        let menuItems = [
            { id: 1, name: 'Nasi Goreng Spesial', price: 15000, description: 'Nasi goreng dengan telur, ayam, dan bakso.', image: 'https://placehold.co/600x400/f8b400/ffffff?text=Nasi+Goreng', available: true },
            { id: 2, name: 'Mie Ayam Komplit', price: 12000, description: 'Mie ayam dengan pangsit dan bakso.', image: 'https://placehold.co/600x400/f87171/ffffff?text=Mie+Ayam', available: true },
            { id: 3, name: 'Soto Ayam', price: 10000, description: 'Soto bening dengan suwiran ayam dan soun.', image: 'https://placehold.co/600x400/a3e635/ffffff?text=Soto+Ayam', available: false },
            { id: 4, name: 'Es Teh Manis', price: 3000, description: 'Minuman teh manis yang menyegarkan.', image: 'https://placehold.co/600x400/38bdf8/ffffff?text=Es+Teh', available: true },
            { id: 5, name: 'Jus Alpukat', price: 8000, description: 'Jus buah alpukat segar dengan susu.', image: 'https://placehold.co/600x400/16a34a/ffffff?text=Jus+Alpukat', available: true },
        ];

        let orders = [
            { id: 101, nis: '12345', items: [{...menuItems[0], qty: 1}, {...menuItems[3], qty: 1}], total: 18000, status: 'Siap Diambil', timestamp: new Date() },
            { id: 102, nis: '54321', items: [{...menuItems[1], qty: 2}], total: 24000, status: 'Sedang Disiapkan', timestamp: new Date() },
        ];

        // --- STATE MANAGEMENT APLIKASI ---
        // Mengelola halaman mana yang tampil dan siapa yang login.
        const state = {
            currentPage: 'login', // 'login', 'adminDashboard', 'adminMenu', 'siswaMenu', 'siswaCart', 'siswaOrders'
            currentUser: null, // null, { role: 'admin' }, { role: 'siswa', nis: '...' }
            cart: [], // Untuk keranjang belanja siswa
            isMenuModalOpen: false, // For add/edit menu modal
            editingMenuItem: null, // null for new, object for editing
            notification: { message: '', type: '' }, // Untuk menampilkan notifikasi
            coverImage: 'https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=2070&auto=format&fit=crop' // URL Gambar Sampul
        };
        
        const appContainer = document.getElementById('app');

        // --- FUNGSI UTAMA UNTUK MERENDER HALAMAN ---
        function render() {
            appContainer.innerHTML = '';
            showNotification(); // Tampilkan notifikasi jika ada

            switch (state.currentPage) {
                case 'login':
                    appContainer.innerHTML = LoginPage();
                    break;
                case 'adminDashboard':
                    appContainer.innerHTML = AdminDashboardPage();
                    break;
                case 'adminMenu':
                    appContainer.innerHTML = AdminMenuPage();
                    if (state.isMenuModalOpen) {
                        appContainer.insertAdjacentHTML('beforeend', AdminMenuModal());
                        lucide.createIcons(); // Re-render icons for the modal
                    }
                    break;
                case 'siswaMenu':
                    appContainer.innerHTML = SiswaLayout(SiswaMenuPage());
                    break;
                case 'siswaCart':
                    appContainer.innerHTML = SiswaLayout(SiswaCartPage());
                    break;
                case 'siswaOrders':
                    appContainer.innerHTML = SiswaLayout(SiswaOrdersPage());
                    break;
                default:
                    appContainer.innerHTML = LoginPage();
            }
            lucide.createIcons(); // Agar ikon dapat dirender setelah update DOM
        }

        // --- FUNGSI NOTIFIKASI ---
        function setNotification(message, type = 'success') {
            state.notification = { message, type };
            showNotification();
            setTimeout(() => {
                state.notification = { message: '', type: '' };
                const notifEl = document.getElementById('notification-banner');
                if (notifEl) notifEl.remove();
            }, 3000);
        }

        function showNotification() {
            const existingNotif = document.getElementById('notification-banner');
            if(existingNotif) existingNotif.remove();
            
            if (state.notification.message) {
                const bgColor = state.notification.type === 'success' ? 'bg-emerald-500' : 'bg-rose-500';
                const notifHTML = `
                    <div id="notification-banner" class="fixed top-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg animate-fade-in-up z-50">
                        ${state.notification.message}
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', notifHTML);
            }
        }

        // --- KOMPONEN TAMPILAN (VIEWS) ---

        // HALAMAN LOGIN
        function LoginPage() {
            // Panggil toggleLogin setelah render untuk set state awal
            setTimeout(() => toggleLogin('siswa'), 0);
            return `
                <div class="min-h-screen flex items-center justify-center p-4 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=2070&auto=format&fit=crop')">
                    <div class="absolute inset-0 bg-black bg-opacity-40"></div>
                    <div class="relative w-full max-w-md bg-white rounded-2xl shadow-xl p-8 animate-fade-in-up">
                        <div class="text-center mb-8">
                            <i data-lucide="utensils-crossed" class="w-16 h-16 mx-auto text-emerald-500"></i>
                            <h1 class="text-3xl font-bold text-gray-800 mt-4">Kantin Siswa Digital</h1>
                            <p class="text-gray-500 mt-2">Pesan makanan favoritmu jadi lebih mudah</p>
                        </div>
                        
                        <div id="login-form-container">
                            <!-- Konten form dimuat oleh toggleLogin -->
                        </div>
                        
                        <div class="text-center mt-6 p-1 bg-gray-200 rounded-lg flex">
                            <button onclick="toggleLogin('siswa')" id="btn-siswa-tab" class="w-1/2 px-4 py-2 text-sm font-semibold rounded-md transition-all duration-300">Siswa</button>
                            <button onclick="toggleLogin('admin')" id="btn-admin-tab" class="w-1/2 px-4 py-2 text-sm font-semibold rounded-md transition-all duration-300">Admin</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function SiswaLoginForm() {
            return `
                <form onsubmit="handleLogin(event, 'siswa')" class="animate-fade-in-up">
                    <h2 class="text-xl font-semibold text-center mb-4 text-gray-700">Login Siswa</h2>
                    <div>
                        <label for="nis" class="block text-sm font-medium text-gray-600 mb-1">Nama Siswa</label>
                        <input type="text" id="nis" name="nis" required class="w-full px-4 py-3 bg-slate-100 border-transparent rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="Contoh: Budi">
                    </div>
                    <button type="submit" class="w-full btn-primary py-3 px-4 rounded-lg mt-6">Masuk</button>
                </form>
            `;
        }

        function AdminLoginForm() {
            return `
                <form onsubmit="handleLogin(event, 'admin')" class="animate-fade-in-up">
                    <h2 class="text-xl font-semibold text-center mb-4 text-gray-700">Login Admin</h2>
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-600 mb-1">Username</label>
                        <input type="text" id="username" name="username" required class="w-full px-4 py-3 bg-slate-100 border-transparent rounded-lg focus:ring-emerald-500 focus:border-emerald-500" value="admin">
                    </div>
                    <div class="mt-4">
                        <label for="password" class="block text-sm font-medium text-gray-600 mb-1">Sandi</label>
                        <input type="password" id="password" name="password" required class="w-full px-4 py-3 bg-slate-100 border-transparent rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="••••••••">
                    </div>
                    <button type="submit" class="w-full btn-primary py-3 px-4 rounded-lg mt-6">Masuk</button>
                </form>
            `;
        }

        // TAMPILAN ADMIN
        function AdminDashboardPage() {
            const todayOrders = orders.filter(o => new Date(o.timestamp).toDateString() === new Date().toDateString());
            const totalRevenue = todayOrders.reduce((sum, order) => sum + order.total, 0);
            
            return `
                <div class="min-h-screen bg-slate-50" style="background-image: url('https://www.transparenttextures.com/patterns/green-fibers.png');">
                    ${AdminHeader()}
                    <main class="p-4 md:p-8 animate-fade-in-up">
                        <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Admin</h1>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="card p-6 flex items-center">
                                <i data-lucide="shopping-cart" class="w-12 h-12 text-teal-500 mr-4"></i>
                                <div>
                                    <p class="text-gray-500">Pesanan Hari Ini</p>
                                    <p class="text-3xl font-bold text-gray-800">${todayOrders.length}</p>
                                </div>
                            </div>
                            <div class="card p-6 flex items-center">
                                <i data-lucide="wallet" class="w-12 h-12 text-emerald-500 mr-4"></i>
                                <div>
                                    <p class="text-gray-500">Pendapatan Hari Ini</p>
                                    <p class="text-3xl font-bold text-gray-800">Rp ${totalRevenue.toLocaleString('id-ID')}</p>
                                </div>
                            </div>
                             <div class="card p-6 flex items-center">
                                <i data-lucide="utensils" class="w-12 h-12 text-amber-500 mr-4"></i>
                                <div>
                                    <p class="text-gray-500">Total Menu</p>
                                    <p class="text-3xl font-bold text-gray-800">${menuItems.length}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card p-6 mt-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Kelola Gambar Sampul</h2>
                            <p class="text-gray-500 mb-4">Gambar ini akan tampil di halaman menu siswa.</p>
                            <img src="${state.coverImage || 'https://placehold.co/1200x400/e2e8f0/94a3b8?text=Tidak+Ada+Sampul'}" alt="Cover Preview" class="w-full h-48 object-cover rounded-lg mb-4">
                            <form onsubmit="handleCoverImageUpdate(event)">
                                <label for="cover-url" class="block text-sm font-medium text-gray-600 mb-1">URL Gambar Sampul</label>
                                <div class="flex gap-2">
                                    <input type="text" id="cover-url" name="coverUrl" required class="w-full px-4 py-2 bg-slate-100 border-transparent rounded-lg focus:ring-emerald-500 focus:border-emerald-500" placeholder="https://..." value="${state.coverImage || ''}">
                                    <button type="submit" class="btn-primary text-white font-semibold px-4 py-2 rounded-lg">Simpan</button>
                                </div>
                            </form>
                        </div>

                        <div class="card p-6 mt-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Pesanan Masuk</h2>
                            <div class="space-y-4">
                                ${orders.length > 0 ? orders.map(order => AdminOrderCard(order)).join('') : '<p class="text-gray-500">Belum ada pesanan.</p>'}
                            </div>
                        </div>
                    </main>
                </div>
            `;
        }

        function AdminOrderCard(order) {
            const statusColors = {
                'Diterima': 'bg-blue-100 text-blue-800',
                'Sedang Disiapkan': 'bg-amber-100 text-amber-800',
                'Siap Diambil': 'bg-emerald-100 text-emerald-800',
                'Selesai': 'bg-slate-200 text-slate-800'
            };
            const actions = {
                'Diterima': `<button onclick="updateOrderStatus(${order.id}, 'Sedang Disiapkan')" class="bg-amber-500 text-white px-3 py-1 rounded-md text-sm hover:bg-amber-600 transition">Siapkan</button>`,
                'Sedang Disiapkan': `<button onclick="updateOrderStatus(${order.id}, 'Siap Diambil')" class="bg-emerald-500 text-white px-3 py-1 rounded-md text-sm hover:bg-emerald-600 transition">Siap Diambil</button>`,
                'Siap Diambil': `<button onclick="updateOrderStatus(${order.id}, 'Selesai')" class="bg-slate-500 text-white px-3 py-1 rounded-md text-sm hover:bg-slate-600 transition">Selesaikan</button>`,
                'Selesai': `<span class="text-sm text-gray-500">Selesai</span>`
            };
            return `
                <div class="border rounded-lg p-4 flex flex-col md:flex-row justify-between items-start md:items-center animate-fade-in-up">
                    <div>
                        <p class="font-bold text-lg">Pesanan #${order.id} <span class="text-sm font-normal text-gray-500">- Siswa: ${order.nis}</span></p>
                        <ul class="list-disc list-inside text-gray-600">
                            ${order.items.map(item => `<li>${item.qty}x ${item.name}</li>`).join('')}
                        </ul>
                        <p class="font-semibold mt-2">Total: Rp ${order.total.toLocaleString('id-ID')}</p>
                    </div>
                    <div class="mt-4 md:mt-0 flex items-center gap-4">
                        <span class="text-sm font-semibold px-3 py-1 rounded-full ${statusColors[order.status]}">${order.status}</span>
                        ${actions[order.status]}
                    </div>
                </div>
            `;
        }

        function AdminMenuPage() {
            // Modal untuk tambah/edit menu disembunyikan secara default
            return `
                <div class="min-h-screen bg-slate-50" style="background-image: url('https://www.transparenttextures.com/patterns/green-fibers.png');">
                    ${AdminHeader()}
                    <main class="p-4 md:p-8 animate-fade-in-up">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold text-gray-800">Kelola Menu</h1>
                            <!-- Tombol ini sekarang berfungsi -->
                            <button onclick="openMenuModal()" class="btn-primary text-white font-semibold px-4 py-2 rounded-lg flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                                Tambah Menu
                            </button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${menuItems.map(item => AdminMenuCard(item)).join('')}
                        </div>
                    </main>
                </div>
            `;
        }

        function AdminMenuCard(item) {
            return `
                 <div class="card overflow-hidden animate-fade-in-up">
                    <img class="h-48 w-full object-cover" src="${item.image}" alt="${item.name}">
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800">${item.name}</h3>
                        <p class="text-gray-600 mt-1">Rp ${item.price.toLocaleString('id-ID')}</p>
                        <p class="text-gray-500 text-sm mt-2">${item.description}</p>
                        <div class="flex justify-between items-center mt-4">
                            <div class="flex items-center">
                                <label for="toggle-${item.id}" class="flex items-center cursor-pointer">
                                    <div class="relative">
                                        <input type="checkbox" id="toggle-${item.id}" class="sr-only" ${item.available ? 'checked' : ''} onchange="toggleAvailability(${item.id})">
                                        <div class="block bg-gray-300 w-12 h-7 rounded-full"></div>
                                        <div class="dot absolute left-1 top-1 bg-white w-5 h-5 rounded-full transition"></div>
                                    </div>
                                    <div class="ml-3 text-gray-700 font-medium text-sm">
                                        ${item.available ? 'Tersedia' : 'Habis'}
                                    </div>
                                </label>
                            </div>
                             <!-- Tombol ini sekarang berfungsi -->
                            <button onclick="openMenuModal(${item.id})" class="text-emerald-500 hover:text-emerald-700 font-semibold text-sm">Edit</button>
                        </div>
                    </div>
                </div>
                <style>
                    input:checked ~ .dot {
                        transform: translateX(100%);
                        background-color: #f0fdf4; /* green-50 */
                    }
                     input:checked ~ .block {
                        background-color: #10b981; /* emerald-500 */
                    }
                </style>
            `;
        }
        
         function AdminHeader() {
             return `
                <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-20 border-b border-slate-200">
                    <nav class="container mx-auto px-4 md:px-8 py-4 flex justify-between items-center">
                        <div class="text-2xl font-bold text-emerald-600 flex items-center gap-2">
                            <i data-lucide="shield-check"></i>
                            <span>Admin Kantin</span>
                        </div>
                        <div class="flex items-center gap-6">
                            <a href="#" onclick="navigateTo('adminDashboard')" class="text-gray-600 hover:text-emerald-600 font-semibold transition">Dashboard</a>
                            <a href="#" onclick="navigateTo('adminMenu')" class="text-gray-600 hover:text-emerald-600 font-semibold transition">Kelola Menu</a>
                            <button onclick="handleLogout()" class="bg-red-100 text-red-600 font-semibold px-4 py-2 rounded-lg hover:bg-red-200 transition flex items-center gap-2">
                                <i data-lucide="log-out" class="w-5 h-5"></i>
                                Keluar
                            </button>
                        </div>
                    </nav>
                </header>
            `;
        }

        // TAMPILAN SISWA
        function SiswaLayout(content) {
             return `
                <div class="pb-24 min-h-screen" style="background-image: url('https://www.transparenttextures.com/patterns/green-fibers.png');">
                   <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-10 p-4 flex justify-between items-center border-b border-slate-200">
                        <div>
                             <h1 class="text-xl font-bold text-gray-800">Kantin Siswa Digital</h1>
                             <p class="text-sm text-gray-500">Selamat datang, Siswa: ${state.currentUser.nis}</p>
                        </div>
                        <button onclick="handleLogout()" class="text-red-500 hover:bg-red-100 p-2 rounded-full transition">
                             <i data-lucide="log-out" class="w-6 h-6"></i>
                        </button>
                   </header>
                   <main class="p-4">${content}</main>
                   ${SiswaBottomNav()}
                </div>
            `;
        }

        function SiswaMenuPage() {
            const coverSection = state.coverImage ? `
                <div class="mb-6 rounded-xl overflow-hidden shadow-lg animate-fade-in-up">
                    <img src="${state.coverImage}" alt="Promosi Kantin" class="w-full h-40 object-cover">
                </div>
            ` : '';

            return `
                ${coverSection}
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    ${menuItems.map(item => {
                        const disabled = !item.available ? 'opacity-50 cursor-not-allowed' : '';
                        const clickHandler = item.available ? `onclick="addToCart(${item.id})"` : '';
                        return `
                            <div class="card overflow-hidden animate-fade-in-up ${disabled}">
                                <img src="${item.image}" alt="${item.name}" class="w-full h-32 object-cover">
                                <div class="p-3">
                                    <h3 class="font-bold text-md truncate">${item.name}</h3>
                                    <p class="text-sm text-gray-600">Rp ${item.price.toLocaleString('id-ID')}</p>
                                    <button ${clickHandler} class="mt-2 w-full text-sm font-semibold py-2 rounded-md transition ${item.available ? 'btn-primary' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}">
                                        ${item.available ? 'Tambah' : 'Habis'}
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function SiswaCartPage() {
            if (state.cart.length === 0) {
                return `
                    <div class="text-center mt-20 animate-fade-in-up">
                        <i data-lucide="shopping-basket" class="w-24 h-24 mx-auto text-gray-300"></i>
                        <h2 class="mt-4 text-xl font-semibold text-gray-700">Keranjang Kosong</h2>
                        <p class="text-gray-500">Yuk, pilih menu favoritmu!</p>
                    </div>
                `;
            }

            const total = state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            return `
                <div class="card p-4 animate-fade-in-up">
                    <h2 class="text-2xl font-bold mb-4">Keranjang Saya</h2>
                    <div class="space-y-4">
                        ${state.cart.map(item => `
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="font-semibold">${item.name}</p>
                                    <p class="text-sm text-gray-500">Rp ${item.price.toLocaleString('id-ID')}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="updateCartQty(${item.id}, -1)" class="w-7 h-7 bg-gray-200 rounded-full font-bold">-</button>
                                    <span>${item.qty}</span>
                                    <button onclick="updateCartQty(${item.id}, 1)" class="w-7 h-7 bg-gray-200 rounded-full font-bold">+</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <hr class="my-4">
                    <div class="flex justify-between items-center font-bold text-lg">
                        <p>Total</p>
                        <p>Rp ${total.toLocaleString('id-ID')}</p>
                    </div>
                    <button onclick="placeOrder()" class="mt-6 w-full btn-primary font-bold py-3 rounded-lg transition">Pesan Sekarang</button>
                </div>
            `;
        }

        function SiswaOrdersPage() {
            const myOrders = orders.filter(o => o.nis === state.currentUser.nis).sort((a, b) => b.timestamp - a.timestamp);

            if (myOrders.length === 0) {
                return `
                    <div class="text-center mt-20 animate-fade-in-up">
                        <i data-lucide="receipt" class="w-24 h-24 mx-auto text-gray-300"></i>
                        <h2 class="mt-4 text-xl font-semibold text-gray-700">Belum Ada Pesanan</h2>
                        <p class="text-gray-500">Semua pesananmu akan tampil di sini.</p>
                    </div>
                `;
            }

            const statusColors = {
                'Diterima': 'bg-blue-100 text-blue-800',
                'Sedang Disiapkan': 'bg-amber-100 text-amber-800',
                'Siap Diambil': 'bg-emerald-100 text-emerald-800 animate-pulse',
                'Selesai': 'bg-slate-200 text-slate-800'
            };

            return `
                <div class="space-y-4">
                    <h2 class="text-2xl font-bold">Pesanan Saya</h2>
                    ${myOrders.map(order => `
                        <div class="card p-4 animate-fade-in-up">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-bold">Pesanan #${order.id}</p>
                                    <p class="text-sm text-gray-500">${new Date(order.timestamp).toLocaleString('id-ID')}</p>
                                </div>
                                <span class="text-sm font-semibold px-3 py-1 rounded-full ${statusColors[order.status]}">${order.status}</span>
                            </div>
                            <div class="mt-2">
                                ${order.items.map(i => `<p class="text-gray-700">${i.qty}x ${i.name}</p>`).join('')}
                            </div>
                            <p class="font-semibold text-right mt-2">Total: Rp ${order.total.toLocaleString('id-ID')}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function SiswaBottomNav() {
            const activeClass = 'text-emerald-600';
            const inactiveClass = 'text-gray-400';
            const baseButtonClass = 'flex flex-col items-center justify-center pt-2 pb-1 w-full transition-all duration-300 transform hover:scale-110';
            
            const getButtonClass = (page) => `${baseButtonClass} ${state.currentPage === page ? activeClass : inactiveClass}`;

            return `
                <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-lg border-t border-slate-200 flex justify-around h-16">
                    <button onclick="navigateTo('siswaMenu')" class="${getButtonClass('siswaMenu')}">
                        <i data-lucide="utensils-crossed" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">Menu</span>
                        ${state.currentPage === 'siswaMenu' ? '<div class="w-8 h-1 bg-emerald-600 rounded-full mt-1 animate-fade-in-up"></div>' : '<div class="w-8 h-1 bg-transparent mt-1"></div>'}
                    </button>
                    <button onclick="navigateTo('siswaCart')" class="${getButtonClass('siswaCart')} relative">
                        <i data-lucide="shopping-cart" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">Keranjang</span>
                        ${state.cart.length > 0 ? `<span class="absolute top-0 right-8 bg-red-500 text-white text-[10px] rounded-full w-5 h-5 flex items-center justify-center border-2 border-white">${state.cart.reduce((sum, i) => sum + i.qty, 0)}</span>` : ''}
                        ${state.currentPage === 'siswaCart' ? '<div class="w-8 h-1 bg-emerald-600 rounded-full mt-1 animate-fade-in-up"></div>' : '<div class="w-8 h-1 bg-transparent mt-1"></div>'}
                    </button>
                    <button onclick="navigateTo('siswaOrders')" class="${getButtonClass('siswaOrders')}">
                        <i data-lucide="receipt" class="w-6 h-6"></i>
                        <span class="text-xs mt-1">Pesanan</span>
                        ${state.currentPage === 'siswaOrders' ? '<div class="w-8 h-1 bg-emerald-600 rounded-full mt-1 animate-fade-in-up"></div>' : '<div class="w-8 h-1 bg-transparent mt-1"></div>'}
                    </button>
                </nav>
            `;
        }

        // --- FUNGSI LOGIC & EVENT HANDLER ---
        
        function navigateTo(page) {
            state.currentPage = page;
            render();
        }

        function toggleLogin(type) {
            const container = document.getElementById('login-form-container');
            const siswaTab = document.getElementById('btn-siswa-tab');
            const adminTab = document.getElementById('btn-admin-tab');
            
            // Define active and inactive classes for tabs
            const activeClasses = ['bg-white', 'text-indigo-600', 'shadow'];
            const inactiveClasses = ['bg-transparent', 'text-gray-600'];

            if (type === 'siswa') {
                container.innerHTML = SiswaLoginForm();
                siswaTab.classList.add(...activeClasses);
                siswaTab.classList.remove(...inactiveClasses);
                adminTab.classList.add(...inactiveClasses);
                adminTab.classList.remove(...activeClasses);
            } else {
                container.innerHTML = AdminLoginForm();
                adminTab.classList.add(...activeClasses);
                adminTab.classList.remove(...inactiveClasses);
                siswaTab.classList.add(...inactiveClasses);
                siswaTab.classList.remove(...activeClasses);
            }
        }

        function handleLogin(event, role) {
            event.preventDefault();
            if (role === 'siswa') {
                const nis = event.target.nis.value;
                if(nis) {
                    state.currentUser = { role: 'siswa', nis };
                    state.currentPage = 'siswaMenu';
                }
            } else if (role === 'admin') {
                const username = event.target.username.value;
                const password = event.target.password.value;
                // Validasi sederhana
                if (username === 'admin' && password === 'password') {
                    state.currentUser = { role: 'admin' };
                    state.currentPage = 'adminDashboard';
                } else {
                    setNotification('Username atau sandi salah!', 'error');
                }
            }
            render();
        }

        function handleLogout() {
            state.currentUser = null;
            state.currentPage = 'login';
            state.cart = []; // Kosongkan keranjang saat logout
            render();
        }

        function handleCoverImageUpdate(event) {
            event.preventDefault();
            const newUrl = event.target.coverUrl.value;
            state.coverImage = newUrl;
            setNotification('Gambar sampul berhasil diperbarui!', 'success');
            render();
        }
        
        function openMenuModal(itemId = null) {
            if (itemId) {
                // Find the original item, not a copy, to ensure availability toggle works
                state.editingMenuItem = menuItems.find(item => item.id === itemId);
            } else {
                state.editingMenuItem = null; // Tandai sebagai mode tambah
            }
            state.isMenuModalOpen = true;
            render();
        }

        function closeMenuModal() {
            state.isMenuModalOpen = false;
            state.editingMenuItem = null;
            render();
        }

        function handleMenuFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const formData = {
                name: form.name.value,
                price: parseInt(form.price.value, 10),
                description: form.description.value,
                image: form.image.value || `https://placehold.co/600x400/cccccc/ffffff?text=${form.name.value.replace(/\s/g, '+')}`,
            };

            if (state.editingMenuItem) {
                // Mode Edit
                const index = menuItems.findIndex(item => item.id === state.editingMenuItem.id);
                if (index !== -1) {
                    // Pastikan status 'available' tidak ter-reset
                    menuItems[index] = { ...menuItems[index], ...formData };
                }
                setNotification('Menu berhasil diperbarui!', 'success');
            } else {
                // Mode Tambah
                const newItem = { ...formData, id: Date.now(), available: true }; // Menu baru selalu tersedia
                menuItems.push(newItem);
                setNotification('Menu baru berhasil ditambahkan!', 'success');
            }
            closeMenuModal();
        }

        function handleDeleteMenu(itemId) {
            menuItems = menuItems.filter(item => item.id !== itemId);
            setNotification('Menu berhasil dihapus!', 'success');
            closeMenuModal();
        }
        
        function toggleAvailability(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            if (item) {
                item.available = !item.available;
            }
            render();
        }

        function AdminMenuModal() {
            const isEditing = state.editingMenuItem !== null;
            const item = isEditing ? state.editingMenuItem : { id: null, name: '', price: '', description: '', image: '' };
            const title = isEditing ? 'Edit Menu' : 'Tambah Menu Baru';
            const buttonText = isEditing ? 'Simpan Perubahan' : 'Tambah Menu';

            return `
                <div id="menu-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 animate-fade-in-up">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative">
                        <button onclick="closeMenuModal()" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                        <h2 class="text-2xl font-bold mb-4">${title}</h2>
                        <form onsubmit="handleMenuFormSubmit(event)">
                            <div class="space-y-4">
                                <div>
                                    <label for="menu-name" class="block text-sm font-medium text-gray-700">Nama Menu</label>
                                    <input type="text" id="menu-name" name="name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500" value="${item.name}" required>
                                </div>
                                <div>
                                    <label for="menu-price" class="block text-sm font-medium text-gray-700">Harga</label>
                                    <input type="number" id="menu-price" name="price" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500" value="${item.price}" required>
                                </div>
                                <div>
                                    <label for="menu-description" class="block text-sm font-medium text-gray-700">Deskripsi</label>
                                    <textarea id="menu-description" name="description" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500">${item.description}</textarea>
                                </div>
                                <div>
                                    <label for="menu-image" class="block text-sm font-medium text-gray-700">URL Gambar</label>
                                    <input type="text" id="menu-image" name="image" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500" value="${item.image}" placeholder="https://placehold.co/...">
                                </div>
                            </div>
                            <div class="mt-6 flex justify-between items-center">
                                <div>
                                    ${isEditing ? `<button type="button" onclick="handleDeleteMenu(${item.id})" class="bg-red-500 text-white font-semibold px-4 py-2 rounded-lg hover:bg-red-600 flex items-center gap-2"><i data-lucide="trash-2" class="w-4 h-4"></i> Hapus</button>` : ''}
                                </div>
                                <div class="flex gap-2">
                                    <button type="button" onclick="closeMenuModal()" class="bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300">Batal</button>
                                    <button type="submit" class="btn-primary text-white font-semibold px-4 py-2 rounded-lg">${buttonText}</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function updateOrderStatus(orderId, newStatus) {
            const order = orders.find(o => o.id === orderId);
            if(order) {
                order.status = newStatus;
            }
            render();
        }

        function addToCart(itemId) {
            const itemInCart = state.cart.find(i => i.id === itemId);
            if (itemInCart) {
                itemInCart.qty++;
            } else {
                const itemToAdd = menuItems.find(i => i.id === itemId);
                state.cart.push({ ...itemToAdd, qty: 1 });
            }
            setNotification('Menu ditambahkan ke keranjang!', 'success');
            render();
        }
        
        function updateCartQty(itemId, change) {
            const itemInCart = state.cart.find(i => i.id === itemId);
            if (itemInCart) {
                itemInCart.qty += change;
                if (itemInCart.qty <= 0) {
                    state.cart = state.cart.filter(i => i.id !== itemId);
                }
            }
            render();
        }

        function placeOrder() {
            if (state.cart.length === 0) return;
            
            const newOrder = {
                id: Date.now(),
                nis: state.currentUser.nis,
                items: [...state.cart],
                total: state.cart.reduce((sum, item) => sum + (item.price * item.qty), 0),
                status: 'Diterima',
                timestamp: new Date()
            };
            orders.unshift(newOrder); // Tambah ke awal array
            state.cart = [];
            state.currentPage = 'siswaOrders';
            setNotification('Pesanan berhasil dibuat!', 'success');
            render();
        }


        // --- INISIALISASI APLIKASI ---
        document.addEventListener('DOMContentLoaded', () => {
            render();
        });
    </script>
</body>
</html>
